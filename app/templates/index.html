
<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        // Initialize PostHog with error handling to prevent blocking page functionality
        // Create stub first to prevent errors
        window.posthog = window.posthog || {
            capture: function() {},
            init: function() {},
            identify: function() {},
            reset: function() {}
        };
        
        // Suppress PostHog network errors from showing in console (ad blockers)
        const originalError = console.error;
        console.error = function(...args) {
            if (args.some(arg => typeof arg === 'string' && (arg.includes('posthog') || arg.includes('ERR_BLOCKED_BY_CLIENT')))) {
                return; // Suppress PostHog-related errors
            }
            originalError.apply(console, args);
        };
        
        // Try to initialize PostHog asynchronously
        (function() {
            try {
                !function(t,e){var o,n,p,r;e.__SV||(window.posthog && window.posthog.__loaded)||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.onerror=function(){};p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init Xr es pi Zr rs Kr Qr capture Ni calculateEventProperties os register register_once register_for_session unregister unregister_for_session ds getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSurveysLoaded onSessionId getSurveys getActiveMatchingSurveys renderSurvey displaySurvey cancelPendingSurvey canRenderSurvey canRenderSurveyAsync identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException startExceptionAutocapture stopExceptionAutocapture loadToolbar get_property getSessionProperty us ns createPersonProfile hs Vr vs opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing get_explicit_consent_status is_capturing clear_opt_in_out_capturing ss debug O ls getPageViewId captureTraceFeedback captureTraceMetric qr".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
                if (window.posthog && window.posthog.init) {
                    window.posthog.init('phc_H7IVdBRysGFlumQD3AJWZ7ertz7hueDDCfeoW0tPAhp', {
                        api_host: 'https://us.i.posthog.com',
                        defaults: '2025-11-30',
                        person_profiles: 'identified_only',
                        loaded: function() {
                            // Restore console.error after successful load
                            console.error = originalError;
                        }
                    });
                }
            } catch (e) {
                // Silently fail - ad blocker is blocking PostHog
            }
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bling My Deck - MTG Card Upgrade Finder</title>
    <meta name="description" content="Paste your Magic: The Gathering decklist to find cooler, alternate art, or special frame versions of your cards.">
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- Basic Styling -->
    <style>
        :root {
            --error-color: #ff6b6b;
            --font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        body {
            font-family: var(--font-family);
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        body.dark-mode {
            background-color: #111827;
            color: #e5e7eb;
        }
        body.dark-mode .settings-panel {
            background-color: #030712;
            border-color: #1f2937;
        }
        body.dark-mode textarea {
            background-color: #030712;
            color: #e5e7eb;
            border-color: #1f2937;
        }
        body.dark-mode .card {
            background-color: #030712;
        }
        body.dark-mode h1 {
            color: #e5e7eb;
        }

        main {
            width: 100%;
            max-width: 1200px;
        }
        h1, p {
            text-align: center;
        }
        h1 {
            color: #1a202c;
        }
        p {
            max-width: 60ch;
            margin: 1rem auto;
        }
        form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .settings-panel {
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            padding: 0.75rem 1rem;
            background-color: #ffffff;
        }
        .settings-panel summary {
            cursor: pointer;
            font-weight: 600;
            color: #2a4365;
        }
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 0.75rem;
        }
        .settings-field {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            font-size: 0.9rem;
        }
        .settings-field label {
            font-weight: 600;
        }
        .settings-inline {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        select {
            padding: 0.35rem 0.5rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }
        textarea {
            width: 100%;
            height: 200px;
            background-color: #ffffff;
            color: #333;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 1rem;
            resize: vertical;
        }
        button {
            padding: 12px 20px;
            background-color: #3b82f6;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            align-self: center;
        }
        button:hover {
            background-color: #2563eb;
        }
        .htmx-indicator {
            display: none;
            text-align: center;
            margin-top: 2rem;
            font-size: 1.2rem;
        }
        .htmx-request .htmx-indicator,
        body.htmx-request #loading-spinner,
        form.htmx-request ~ #loading-spinner {
            display: block !important;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        body.dark-mode .spinner {
            border-color: #1f2937;
            border-top-color: #3b82f6;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            color: #718096;
            font-size: 1rem;
        }
        body.dark-mode .loading-text {
            color: #9ca3af;
        }
        .htmx-request button {
            cursor: not-allowed;
            opacity: 0.7;
        }
        #results-container {
            margin-top: 2rem;
        }

        /* --- Card Gallery Styling --- */
        h2 {
            color: #2a4365;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
            margin-top: 40px;
        }
        .card-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            padding: 20px 0;
            margin-bottom: 1rem;
        }
        .card {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            background-color: #fff;
        }
        .card:hover {
            transform: scale(1.05);
        }
        .card img {
            display: block;
            width: 100%;
            height: auto;
        }
        .card.original {
            border: 4px solid #f56565;
        }
        .card-details {
            padding: 10px 5px 0 5px;
            text-align: center;
            font-size: 0.8em;
            color: #718096;
            height: 50px;
        }
        .prices {
            padding: 5px;
            text-align: center;
            font-size: 0.9em;
            height: 30px;
        }
        .prices span {
            margin: 0 5px;
        }
        .error-message {
            color: var(--error-color);
            font-weight: bold;
            padding: 1rem;
        }
        .card.extra-card {
            display: none;
        }
        .load-more-container {
            text-align: center;
            margin-top: 0.5rem;
        }
        .load-more-btn {
            padding: 6px 12px;
            background-color: #3b82f6;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .load-more-btn:hover {
            background-color: #2563eb;
        }

        /* --- Shopping Cart Styling --- */
        .card-add-button-container {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 10;
        }
        .card-add-button {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.9);
            border: 2px solid #3b82f6;
            color: #3b82f6;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            padding: 0;
        }
        .card-add-button:hover {
            background-color: #3b82f6;
            color: white;
            transform: scale(1.1);
        }
        .card-add-button.in-cart {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .card-add-button.in-cart:hover {
            background-color: #2563eb;
            border-color: #2563eb;
        }
        .card-add-button svg {
            width: 14px;
            height: 14px;
        }
        .foil-options-menu {
            position: absolute;
            top: 40px;
            right: 0;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            min-width: 120px;
            z-index: 20;
        }
        .foil-options-menu button {
            display: block;
            width: 100%;
            padding: 8px 12px;
            background-color: white;
            border: none;
            border-bottom: 1px solid #e2e8f0;
            color: #333;
            font-size: 0.9rem;
            cursor: pointer;
            text-align: left;
            transition: background-color 0.2s;
        }
        .foil-options-menu button:last-child {
            border-bottom: none;
        }
        .foil-options-menu button:hover {
            background-color: #f0f2f5;
        }
        body.dark-mode .foil-options-menu {
            background-color: #030712;
            border-color: #1f2937;
        }
        body.dark-mode .foil-options-menu button {
            background-color: #030712;
            color: #e5e7eb;
            border-color: #1f2937;
        }
        body.dark-mode .foil-options-menu button:hover {
            background-color: #1f2937;
        }

        /* Shopping Cart Sidebar */
        .cart-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background-color: white;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        .cart-sidebar.open {
            right: 0;
        }
        .cart-pull-tab {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            width: 40px;
            height: 120px;
            background-color: #3b82f6;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: -2px 0 4px rgba(0, 0, 0, 0.2);
            z-index: 999;
            transition: background-color 0.2s;
        }
        .cart-pull-tab:hover {
            background-color: #2563eb;
        }
        .cart-pull-tab svg {
            width: 24px;
            height: 24px;
            color: white;
        }
        .cart-sidebar.open + .cart-pull-tab {
            right: 400px;
        }
        .cart-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cart-header h3 {
            margin: 0;
            color: #2a4365;
        }
        .cart-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #718096;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cart-close-btn:hover {
            color: #2a4365;
        }
        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .cart-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }
        .cart-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .cart-item img {
            width: 60px;
            height: auto;
            border-radius: 4px;
        }
        .cart-item-info {
            flex: 1;
            font-size: 0.9rem;
        }
        .cart-item-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: #2a4365;
        }
        .cart-item-details {
            color: #718096;
            font-size: 0.85rem;
        }
        .cart-item-remove {
            background: none;
            border: none;
            color: #e53e3e;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cart-item-remove:hover {
            color: #c53030;
        }
        .cart-footer {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
        }
        .cart-export {
            margin-bottom: 12px;
        }
        .cart-export textarea {
            width: 100%;
            min-height: 100px;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            resize: vertical;
        }
        .cart-copy-btn {
            width: 100%;
            padding: 10px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .cart-copy-btn:hover {
            background-color: #2563eb;
        }
        .cart-empty {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
        }
        body.dark-mode .cart-sidebar {
            background-color: #030712;
            border-color: #1f2937;
        }
        body.dark-mode .cart-header,
        body.dark-mode .cart-footer {
            border-color: #1f2937;
        }
        body.dark-mode .cart-header h3 {
            color: #e5e7eb;
        }
        body.dark-mode .cart-item {
            border-color: #1f2937;
        }
        body.dark-mode .cart-item-name {
            color: #e5e7eb;
        }
        body.dark-mode .cart-export textarea {
            background-color: #030712;
            color: #e5e7eb;
            border-color: #1f2937;
        }
    </style>
</head>
<body>
    <main>
        <header>
            <h1>Bling My Deck</h1>
            <p>Paste your decklist below to find awesome alternate-art, extended-art, or special-frame versions of your cards. The app will show you all available printings, sorted by price.</p>
        </header>

        <form 
            method="post"
            action="/analyze"
            hx-post="/analyze" 
            hx-target="#results-container" 
            hx-indicator="#loading-spinner"
            hx-swap="innerHTML">

            <textarea name="decklist" placeholder="1 Sol Ring (C19) 259&#10;4 Counterspell&#10;..."></textarea>

            <details class="settings-panel">
                <summary>Settings</summary>
                <div class="settings-grid">
                    <div class="settings-field">
                        <label class="settings-inline">
                            <input type="checkbox" id="darkmode-toggle">
                            <span>Dark mode (local preference)</span>
                        </label>
                        <small>Uses your browser to remember this preference.</small>
                    </div>

                    <div class="settings-field">
                        <label for="sort-order-select">Sort order</label>
                        <select id="sort-order-select" name="sort_order">
                            <option value="price_down">Price ↓ (expensive → cheap)</option>
                            <option value="price_up">Price ↑ (cheap → expensive)</option>
                            <option value="release_down">Release date ↓ (newest → oldest)</option>
                            <option value="release_up">Release date ↑ (oldest → newest)</option>
                        </select>
                    </div>

                    <div class="settings-field">
                        <label class="settings-inline">
                            <input type="checkbox" name="only_paper" value="1">
                            <span>Only show paper versions</span>
                        </label>
                        <small>Hides printings that are digital-only or not available in paper.</small>
                    </div>
                </div>
            </details>

            <button type="submit">Analyze Deck</button>
        </form>

        <div id="loading-spinner" class="htmx-indicator">
            <div class="spinner"></div>
            <p class="loading-text">Analyzing decklist... This may take a moment.</p>
        </div>

        <div id="results-container">
            <!-- Results will be loaded here by HTMX -->
        </div>

    </main>

    <!-- Shopping Cart Sidebar -->
    <div class="cart-sidebar" id="cart-sidebar">
        <div class="cart-header">
            <h3>Shopping List</h3>
            <button class="cart-close-btn" onclick="toggleCart()">×</button>
        </div>
        <div class="cart-items" id="cart-items">
            <div class="cart-empty">Your shopping list is empty</div>
        </div>
        <div class="cart-footer">
            <div class="cart-export">
                <textarea id="cart-export-text" readonly placeholder="Moxfield importable list will appear here..."></textarea>
            </div>
            <button class="cart-copy-btn" onclick="copyCartToClipboard()">Copy to Clipboard</button>
        </div>
    </div>
    <div class="cart-pull-tab" id="cart-pull-tab" onclick="toggleCart()">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 3H5L5.4 5M7 13H17L21 5H5.4M7 13L5.4 5M7 13L4.7 15.3C4.3 15.7 4.6 16.5 5.1 16.5H17M17 13V17C17 18.1 17.9 19 19 19C20.1 19 21 18.1 21 17V13M9 19.5C9.8 19.5 10.5 20.2 10.5 21C10.5 21.8 9.8 22.5 9 22.5C8.2 22.5 7.5 21.8 7.5 21C7.5 20.2 8.2 19.5 9 19.5ZM20 19.5C20.8 19.5 21.5 20.2 21.5 21C21.5 21.8 20.8 22.5 20 22.5C19.2 22.5 18.5 21.8 18.5 21C18.5 20.2 19.2 19.5 20 19.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </div>
    <script>
        // Simple dark mode toggle using a body class and localStorage
        (function () {
            const body = document.body;
            const toggle = document.getElementById('darkmode-toggle');
            const DARK_KEY = 'blingmydeck-darkmode';

            function applyDarkMode(enabled) {
                if (enabled) {
                    body.classList.add('dark-mode');
                } else {
                    body.classList.remove('dark-mode');
                }
            }

            const stored = window.localStorage.getItem(DARK_KEY);
            const enabled = stored === 'true';
            applyDarkMode(enabled);
            if (toggle) {
                toggle.checked = enabled;
                toggle.addEventListener('change', function () {
                    const on = !!toggle.checked;
                    window.localStorage.setItem(DARK_KEY, String(on));
                    applyDarkMode(on);
                });
            }
        })();

        // Delegate clicks on "Load more printings" buttons so it works for HTMX-loaded content
        document.addEventListener('click', function (event) {
            const btn = event.target.closest('.load-more-btn');
            if (!btn) return;

            const targetId = btn.getAttribute('data-target-id');
            const gallery = document.getElementById(targetId);
            if (!gallery) return;

            const extraCards = gallery.querySelectorAll('.card.extra-card');
            extraCards.forEach(function (card) {
                const img = card.querySelector('img[data-src]');
                if (img && !img.getAttribute('src')) {
                    img.setAttribute('src', img.getAttribute('data-src'));
                }
                card.classList.remove('extra-card');
            });

            btn.remove();
        });

        // Shopping Cart Functionality
        let cart = JSON.parse(localStorage.getItem('blingmydeck-cart') || '[]');

        function saveCart() {
            localStorage.setItem('blingmydeck-cart', JSON.stringify(cart));
            renderCart();
        }

        function showFoilOptions(button) {
            // Close any other open menus
            document.querySelectorAll('.foil-options-menu').forEach(menu => {
                if (menu !== button.nextElementSibling) {
                    menu.style.display = 'none';
                }
            });
            
            const menu = button.nextElementSibling;
            if (!menu) return;
            
            const isOpen = menu.style.display === 'block';
            menu.style.display = isOpen ? 'none' : 'block';
            
            // Close menu when clicking outside
            if (!isOpen) {
                setTimeout(() => {
                    const closeMenu = function(e) {
                        if (!button.contains(e.target) && !menu.contains(e.target)) {
                            menu.style.display = 'none';
                            document.removeEventListener('click', closeMenu);
                        }
                    };
                    document.addEventListener('click', closeMenu);
                }, 0);
            }
        }

        function addToCart(button, foilType) {
            const cardElement = button.closest('.card');
            if (!cardElement) return;

            const cardId = cardElement.getAttribute('data-card-id');
            const cardName = cardElement.getAttribute('data-card-name');
            const setCode = cardElement.getAttribute('data-set-code');
            const collectorNumber = cardElement.getAttribute('data-collector-number');
            const imageUri = cardElement.getAttribute('data-image-uri');

            // Create unique key for this card printing + foil type
            const cartKey = `${cardId}-${foilType}`;

            // Check if already in cart
            const existingIndex = cart.findIndex(item => item.key === cartKey);
            if (existingIndex >= 0) {
                cart[existingIndex].quantity += 1;
            } else {
                cart.push({
                    key: cartKey,
                    cardId: cardId,
                    cardName: cardName,
                    setCode: setCode,
                    collectorNumber: collectorNumber,
                    imageUri: imageUri,
                    foilType: foilType,
                    quantity: 1
                });
            }

            // Close foil options menu if open
            const menu = cardElement.querySelector('.foil-options-menu');
            if (menu) {
                menu.style.display = 'none';
            }

            // Track PostHog event
            if (window.posthog) {
                const cardIdentifier = setCode ? `${cardName} ${setCode.toUpperCase()}${foilType === 'foil' ? ' F' : ''}` : cardName;
                window.posthog.capture('Add to Cart', {
                    card_name: cardName,
                    set_code: setCode,
                    collector_number: collectorNumber,
                    foil_type: foilType,
                    card_id: cardId,
                    card_identifier: cardIdentifier,
                    quantity: existingIndex >= 0 ? cart[existingIndex].quantity : 1,
                    cart_size: cart.length
                });
            }

            saveCart();
            updateCardButtonStates();
        }

        function removeFromCart(key) {
            cart = cart.filter(item => item.key !== key);
            saveCart();
            updateCardButtonStates();
        }

        function updateCardButtonStates() {
            // Get all card buttons
            const allButtons = document.querySelectorAll('.card-add-button');
            const cartKeys = new Set(cart.map(item => item.key));
            
            allButtons.forEach(button => {
                const cardElement = button.closest('.card');
                if (!cardElement) return;
                
                const cardId = cardElement.getAttribute('data-card-id');
                const hasNonfoil = cardElement.getAttribute('data-has-nonfoil') === 'true';
                const hasFoil = cardElement.getAttribute('data-has-foil') === 'true';
                
                // Check if any variant of this card is in the cart
                let isInCart = false;
                if (hasNonfoil && hasFoil) {
                    // For cards with both options, check if either is in cart
                    isInCart = cartKeys.has(`${cardId}-nonfoil`) || cartKeys.has(`${cardId}-foil`);
                } else {
                    // For single option cards, check the specific type
                    const foilType = hasNonfoil ? 'nonfoil' : 'foil';
                    isInCart = cartKeys.has(`${cardId}-${foilType}`);
                }
                
                if (isInCart) {
                    button.classList.add('in-cart');
                } else {
                    button.classList.remove('in-cart');
                }
            });
        }

        function renderCart() {
            const cartItems = document.getElementById('cart-items');
            const exportText = document.getElementById('cart-export-text');

            if (cart.length === 0) {
                cartItems.innerHTML = '<div class="cart-empty">Your shopping list is empty</div>';
                exportText.value = '';
                return;
            }

            cartItems.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <img src="${item.imageUri}" alt="${item.cardName}">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.cardName}</div>
                        <div class="cart-item-details">
                            ${item.setCode.toUpperCase()} #${item.collectorNumber}<br>
                            ${item.foilType === 'foil' ? 'Foil' : 'Non-Foil'} × ${item.quantity}
                        </div>
                    </div>
                    <button class="cart-item-remove" onclick="removeFromCart('${item.key}')" title="Remove">×</button>
                </div>
            `).join('');

            // Generate Moxfield format
            const moxfieldList = cart.map(item => {
                const foilMarker = item.foilType === 'foil' ? ' *F*' : '';
                return `${item.quantity} ${item.cardName} (${item.setCode.toUpperCase()}) ${item.collectorNumber}${foilMarker}`;
            }).join('\n');
            exportText.value = moxfieldList;
        }

        function toggleCart() {
            const sidebar = document.getElementById('cart-sidebar');
            const pullTab = document.getElementById('cart-pull-tab');
            sidebar.classList.toggle('open');
            if (sidebar.classList.contains('open')) {
                pullTab.style.right = '400px';
            } else {
                pullTab.style.right = '0';
            }
        }

        function copyCartToClipboard() {
            const exportText = document.getElementById('cart-export-text');
            if (!exportText.value) {
                alert('Cart is empty!');
                return;
            }
            
            exportText.select();
            exportText.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                const btn = document.querySelector('.cart-copy-btn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.style.backgroundColor = '#48bb78';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = '#3b82f6';
                }, 2000);
            } catch (err) {
                // Fallback for modern browsers
                navigator.clipboard.writeText(exportText.value).then(() => {
                    const btn = document.querySelector('.cart-copy-btn');
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    btn.style.backgroundColor = '#48bb78';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.backgroundColor = '#3b82f6';
                    }, 2000);
                }).catch(() => {
                    alert('Failed to copy to clipboard');
                });
            }

            // Track PostHog event
            if (window.posthog) {
                window.posthog.capture('Copy Shopping List', {
                    cart_size: cart.length,
                    list_length: exportText.value.length,
                    item_count: cart.reduce((sum, item) => sum + item.quantity, 0)
                });
            }
        }

        // Track Scryfall link clicks
        function trackScryfallClick(link) {
            if (window.posthog) {
                const cardName = link.getAttribute('data-card-name');
                const setCode = link.getAttribute('data-set-code');
                const collectorNumber = link.getAttribute('data-collector-number');
                const cardIdentifier = setCode ? `${cardName} ${setCode.toUpperCase()}` : cardName;
                window.posthog.capture('View Scryfall', {
                    card_name: cardName,
                    set_code: setCode,
                    collector_number: collectorNumber,
                    card_identifier: cardIdentifier,
                    scryfall_uri: link.href
                });
            }
        }

        // Initialize cart on page load
        renderCart();
        updateCardButtonStates();

        // Track Scryfall link clicks (delegated for HTMX-loaded content)
        document.addEventListener('click', function(event) {
            const link = event.target.closest('.scryfall-link');
            if (link) {
                trackScryfallClick(link);
            }
        });

        // Re-render cart after HTMX swaps content (for dynamically loaded cards)
        document.body.addEventListener('htmx:afterSwap', function() {
            renderCart();
            updateCardButtonStates();
        });

        // Show/hide loading spinner for HTMX requests
        document.body.addEventListener('htmx:beforeRequest', function() {
            const spinner = document.getElementById('loading-spinner');
            if (spinner) {
                spinner.style.display = 'block';
            }
        });

        document.body.addEventListener('htmx:afterRequest', function() {
            const spinner = document.getElementById('loading-spinner');
            if (spinner) {
                spinner.style.display = 'none';
            }
        });

        document.body.addEventListener('htmx:responseError', function() {
            const spinner = document.getElementById('loading-spinner');
            if (spinner) {
                spinner.style.display = 'none';
            }
        });
    </script>
</body>
</html>
