name: Build and Deploy
on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * *' # Daily rebuild at 3 AM to refresh card data

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Google Auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Build & Push Container
        run: |
          gcloud builds submit --tag gcr.io/${{ secrets.GCP_PROJECT_ID }}/app:latest .

      - name: Deploy to Cloud Run
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: 'blingmydeck'
          image: 'gcr.io/${{ secrets.GCP_PROJECT_ID }}/app:latest'
          region: 'us-central1'
          flags: '--allow-unauthenticated'